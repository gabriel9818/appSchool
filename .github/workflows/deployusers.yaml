name: Deploy Users Microservices

on:
  push:
    branches:
      - test  # Se ejecuta cuando haces push a la rama test_aws

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout del repositorio
        uses: actions/checkout@v4

      - name: 🔑 Configurar conexión SSH con EC2 y desplegar
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ubuntu@54.224.160.113
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "🔄 Exportando variables de entorno..."
            echo "export DB_HOST=${{ secrets.DB_HOST }}" >> ~/.bashrc
            echo "export DB_USER=${{ secrets.DB_USER }}" >> ~/.bashrc
            echo "export DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> ~/.bashrc
            echo "export DB_NAME=${{ secrets.DB_NAME }}" >> ~/.bashrc
            echo "export DB_PORT=${{ secrets.DB_PORT }}" >> ~/.bashrc
            source ~/.bashrc

            echo "📦 Navegando al directorio del proyecto..."
            cd ~/appSchool/BACKEND/gestion_usuarios

            echo "🔄 Deteniendo servicios existentes..."
            docker-compose down

            echo "⬇️ Obteniendo cambios del repositorio..."
            git pull origin features/test_aws

            echo "🐳 Construyendo y ejecutando los microservicios..."
            docker-compose up -d --build

            echo "✅ Despliegue exitoso en EC2."
