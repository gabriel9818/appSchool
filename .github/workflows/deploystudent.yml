name: Deploy Student Registration Service

on:
  push:
    branches:
      - test
    paths:
      - 'BACKEND/student_registration/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    #  Conectar al servidor EC2 usando SSH
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.EC2_HOST_STUDENT }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY_STUDENT }}
        port: 22
        script: |
          echo "📦 Verificando instalación de Docker..."
          if ! command -v docker &> /dev/null; then
            echo "🔧 Instalando Docker..."
            sudo apt update -y
            sudo apt install -y docker.io
            sudo systemctl start docker
            sudo usermod -aG docker ubuntu
          fi

          echo "📦 Deteniendo contenedor previo..."
          sudo docker stop student_registration_php || true
          sudo docker rm student_registration_php || true

          echo "📦 Descargando la última imagen desde Docker Hub..."
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

          echo "🚀 Iniciando el nuevo contenedor..."
            sudo docker run -d \
            --name student_registration_php \
            -p 9050:9050 \  # 🔄 Usamos un puerto diferente
            -e DB_HOST=${{ secrets.DB_HOST_STUDENT }} \
            -e DB_USER=${{ secrets.DB_USER_STUDENT }} \
            -e DB_PASSWORD=${{ secrets.DB_PASSWORD_STUDENT }} \
            -e DB_NAME=${{ secrets.DB_NAME_STUDENT }} \
            ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

          echo "🔄 Reiniciando Nginx para aplicar cambios..."
          sudo systemctl restart nginx

          echo "✅ Verificando si el contenedor está corriendo..."
          if sudo docker ps -f name=student_registration_php | grep student_registration_php; then
            echo "✅ Contenedor corriendo correctamente."
          else
            echo "❌ Error al iniciar el contenedor. Revisa los logs."
            exit 1
          fi
