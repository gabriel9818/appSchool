name: Deploy Student Registration Service

on:
  push:
    branches:
      - test
    paths:
      - 'BACKEND/student_registration/**'
  pull_request:
    paths:
      - 'BACKEND/student_registration/**'
    branches: ["test", "main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # ğŸ“¥ 1. Checkout del repositorio
    - name: Checkout code
      uses: actions/checkout@v3

    # ğŸ”‘ 2. Login en Docker Hub
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ğŸ³ 3. ConstrucciÃ³n de la imagen Docker
    - name: Build Docker image
      run: |
        docker build $GITHUB_WORKSPACE/BACKEND/student_registration/. \
          --file $GITHUB_WORKSPACE/BACKEND/student_registration/Dockerfile \
          -t ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

    # ğŸ“¤ 4. Subir la imagen a Docker Hub
    - name: Push Docker image to Docker Hub
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    # ğŸ“¡ 1. Conectar a la instancia EC2
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.EC2_HOST_STUDENT }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY_STUDENT }}
        port: 22
        script: |
          echo "ğŸ›  Instalando Nginx y PHP-FPM..."
          sudo apt update -y
          sudo apt install -y nginx php8.1-fpm unzip curl

          echo "ğŸš€ Deteniendo contenedor anterior..."
          sudo docker stop student_registration_php || true
          sudo docker rm student_registration_php || true
          
          echo "â¬‡ï¸ Descargando la Ãºltima imagen desde Docker Hub..."
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest
          
          echo "ğŸ¯ Ejecutando el contenedor en segundo plano..."
          sudo docker run -d --name student_registration_php -p 9000:9000 \
            ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

          echo "ğŸ—‘ Limpiando archivos antiguos en /var/www/html/..."
          sudo rm -rf /var/www/html/*
          
          echo "ğŸ“‚ Copiando archivos desde el contenedor a la instancia..."
          sudo docker cp student_registration_php:/var/www/html/. /var/www/html/

          echo "ğŸ”§ Configurando permisos..."
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html

          echo "âš™ï¸ Configurando Nginx..."
          cat <<EOF | sudo tee /etc/nginx/sites-available/default
          server {
              listen 80;
              server_name _;

              root /var/www/html/public;
              index index.php index.html index.htm;

              location / {
                  try_files \$uri \$uri/ =404;
              }

              location ~ \.php$ {
                  include fastcgi_params;
                  fastcgi_pass 127.0.0.1:9000;
                  fastcgi_index index.php;
                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
              }

              error_log /var/log/nginx/error.log;
              access_log /var/log/nginx/access.log;
          }
          EOF

          echo "ğŸ”„ Reiniciando Nginx y PHP-FPM..."
          sudo systemctl restart nginx
          sudo systemctl restart php8.1-fpm

          echo "âœ… Despliegue completado en EC2"
