name: Deploy Student Registration Service

on:
  push:
    branches:
      - test
    paths:
      - 'BACKEND/student_registration/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build Docker image
      run: |
        docker build $GITHUB_WORKSPACE/BACKEND/student_registration/. \
          -t ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

    - name: Push Docker image to Docker Hub
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.EC2_HOST_STUDENT }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY_STUDENT }}
        port: 22
        script: |
          echo "Actualizando paquetes e instalando Nginx y PHP-FPM..."
          sudo apt update -y
          sudo apt install -y nginx php-fpm

          echo "Configurando Nginx..."
          sudo mv /home/ubuntu/appSchool/BACKEND/student_registration/nginx.conf /etc/nginx/sites-available/default
          sudo systemctl restart nginx

          echo "Deteniendo y eliminando contenedor previo..."
          sudo docker stop student_registration_php || true
          sudo docker rm student_registration_php || true
          
          echo "Descargando la última imagen desde Docker Hub..."
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest
          
          echo "Ejecutando el nuevo contenedor en el puerto 9000..."
          sudo docker run -d \
            --name student_registration_php \
            -v /var/www/html:/var/www/html \
            -p 9000:9000 \
            ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

          echo "Verificando si el contenedor está corriendo..."
          if sudo docker ps -f name=student_registration_php | grep student_registration_php; then
            echo "✅ Contenedor 'student_registration_php' corriendo correctamente en puerto 9000."
          else
            echo "❌ Error al iniciar el contenedor. Revisa los logs."
            exit 1
          fi
