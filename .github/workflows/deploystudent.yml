name: Deploy Student Registration Service

on:
  push:
    branches:
      - test  # ğŸ”„ Se ejecuta solo en la rama 'test'
    paths:
      - 'BACKEND/student_registration/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Conectar a EC2 y desplegar el contenedor
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.EC2_HOST_STUDENT }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY_STUDENT }}
        port: 22
        script: |
          echo "ğŸ“¦ Descargando la Ãºltima imagen de Docker..."
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

          echo "ğŸ”„ Deteniendo y eliminando contenedor anterior..."
          sudo docker stop student_registration_php || true
          sudo docker rm student_registration_php || true

          echo "ğŸš€ Iniciando nuevo contenedor..."
          sudo docker run -d \
            --name student_registration_php \
            -p 9000:9000 \  # ğŸ”„ Usa el mismo puerto configurado en la instancia
            -e DB_HOST=${{ secrets.DB_HOST_STUDENT }} \
            -e DB_USER=${{ secrets.DB_USER_STUDENT }} \
            -e DB_PASSWORD=${{ secrets.DB_PASSWORD_STUDENT }} \
            -e DB_NAME=${{ secrets.DB_NAME_STUDENT }} \
            ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

          echo "ğŸ”„ Reiniciando Nginx..."
          sudo systemctl restart nginx

          echo "âœ… Verificando si el contenedor estÃ¡ corriendo..."
          if sudo docker ps -f name=student_registration_php | grep student_registration_php; then
            echo "âœ… Contenedor corriendo correctamente."
          else
            echo "âŒ Error al iniciar el contenedor. Revisa los logs."
            exit 1
          fi
