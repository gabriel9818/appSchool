name: Deploy Student Registration to EC2

on:
  push:
    branches:
      - test
    paths:
      - 'BACKEND/student_registration/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 🚀 Checkout código
      uses: actions/checkout@v3

    - name: 🔑 Conectar a EC2 y desplegar cambios
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.EC2_HOST_STUDENT }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY_STUDENT }}
        port: 22
        script: |
          echo "📂 Moviéndonos al directorio donde configuraste la aplicación..."
          cd /var/www/html || exit 1  # 🚀 Usa la ruta donde configuraste todo manualmente

          echo "📦 Verificando si el directorio es un repositorio Git..."
          if [ ! -d ".git" ]; then
            echo "⚠️ No es un repositorio Git. Clonando el repositorio..."
            sudo git clone https://github.com/${{ secrets.GITHUB_USERNAME }}/student_registration.git /var/www/html
          else
            echo "✅ Repositorio Git encontrado. Actualizando código..."
            sudo git pull origin test
          fi

          echo "📦 Deteniendo contenedor previo..."
          sudo docker stop student_registration_php || true
          sudo docker rm student_registration_php || true

          echo "📦 Descargando la última imagen de Docker..."
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest

          echo "🚀 Iniciando nuevo contenedor sin modificar configuración..."
          sudo docker run -d \
            --name student_registration_php \
            --network=host \
            -e DB_HOST=${{ secrets.DB_HOST_STUDENT }} \
            -e DB_USER=${{ secrets.DB_USER_STUDENT }} \
            -e DB_PASSWORD=${{ secrets.DB_PASSWORD_STUDENT }} \
            -e DB_NAME=${{ secrets.DB_NAME_STUDENT }} \
            ${{ secrets.DOCKER_USERNAME }}/student_registration_php:latest || exit 1

          echo "🔄 Reiniciando Nginx para aplicar cambios..."
          sudo systemctl restart nginx

          echo "✅ Verificando si el contenedor está corriendo..."
          if sudo docker ps -f name=student_registration_php | grep student_registration_php; then
            echo "✅ Contenedor corriendo correctamente."
          else
            echo "❌ Error al iniciar el contenedor. Revisa los logs."
            exit 1
          fi
