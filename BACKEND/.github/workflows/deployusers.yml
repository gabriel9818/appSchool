name: Deploy User Services to AWS EC2

on:
  push:
    branches:
      - features/test_aws  # Se ejecuta solo cuando hay un push en la rama test_aws

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîΩ Clonar el repositorio
        uses: actions/checkout@v3

      - name: üîë Configurar acceso a EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST_USERS }}
          USER: ubuntu
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

      - name: üì¶ Copiar archivos al servidor EC2
        run: |
          rsync -avz -e "ssh -i private_key.pem -o StrictHostKeyChecking=no" \
          ./BACKEND/gestion_usuarios ubuntu@${{ secrets.EC2_HOST_USERS }}:/home/ubuntu/appschool/

      - name: üê≥ Conectar y desplegar en EC2
        run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST_USERS }} << 'EOF'
          # Ir al directorio del proyecto
          cd /home/ubuntu/appschool/gestion_usuarios
          
          # Verificar si Docker est√° instalado
          if ! command -v docker &> /dev/null; then
            echo "Docker no encontrado, instalando..."
            sudo apt update
            sudo apt install -y docker.io docker-compose
            sudo usermod -aG docker ubuntu
          fi
          
          # Descargar la √∫ltima versi√≥n del repositorio
          git pull origin test_aws

          # Construir y levantar los contenedores
          sudo docker-compose down
          sudo docker-compose build
          sudo docker-compose up -d

          # Verificar estado de los contenedores
          sudo docker ps
          EOF
